<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-GB">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Writing query functions in neuprintr • neuprintr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="48x48" href="../favicon-48x48.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Writing query functions in neuprintr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">neuprintr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.3.2.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/customquery.html">Writing query functions in neuprintr</a>
    </li>
    <li>
      <a href="../articles/hemibrain_opns.html">hemibrain olfactory projection neurons</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/natverse/neuprintr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Writing query functions in neuprintr</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/natverse/neuprintr/blob/master/vignettes/customquery.Rmd" class="external-link"><code>vignettes/customquery.Rmd</code></a></small>
      <div class="hidden name"><code>customquery.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>neuPrint includes both an <a href="https://neuprint.janelia.org/help/api" class="external-link">API</a> which provides a
range of queries as well as the option to send <em>custom queries</em>
written in the <a href="https://neo4j.com/developer/cypher-query-language/" class="external-link">Cypher query
language</a> of the <a href="https://neo4j.com" class="external-link">Neo4j</a> graph
database.</p>
<p>It is probably worth making queries via the API if they will solve
your problem. However custom queries offer maximum flexibility.</p>
</div>
<div class="section level2">
<h2 id="do-you-need-a-function">Do you need a function?<a class="anchor" aria-label="anchor" href="#do-you-need-a-function"></a>
</h2>
<p>It is a great idea to wrap your queries in a function. This will make
your code cleaner and more reusable. But do check the documentation to
ensure that there isn’t already a neuprintr function that does the job.
If there is something that almost looks correct, then consider asking us
to adapt it!</p>
</div>
<div class="section level2">
<h2 id="custom-query-functions">Custom query functions<a class="anchor" aria-label="anchor" href="#custom-query-functions"></a>
</h2>
<p>We’ll start by giving a basic example query function. Most of the
time you should just be able to edit this example without worrying about
the details. The subsequent sections give you some information about
those details.</p>
<div class="section level3">
<h3 id="basic-example">Basic example<a class="anchor" aria-label="anchor" href="#basic-example"></a>
</h3>
<p>This function takes one or more bodyids as input and returns the name
of the neurons.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">neuprint_get_neuron_names</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bodyids</span>, <span class="va">dataset</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">all_segments</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                      <span class="va">conn</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">bodyids</span> <span class="op">=</span> <span class="fu"><a href="../reference/neuprint_search.html">neuprint_ids</a></span><span class="op">(</span><span class="va">bodyids</span>, conn <span class="op">=</span> <span class="va">conn</span>, dataset <span class="op">=</span> <span class="va">dataset</span><span class="op">)</span></span>
<span>  <span class="va">all_segments.json</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">all_segments</span>,<span class="st">"Segment"</span>, <span class="st">"Neuron"</span><span class="op">)</span></span>
<span>  <span class="va">cypher</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"WITH %s AS bodyIds UNWIND bodyIds AS bodyId MATCH (n:`%s`) WHERE n.bodyId=bodyId RETURN n.instance AS name"</span>,</span>
<span>                   <span class="fu">id2json</span><span class="op">(</span><span class="va">bodyids</span><span class="op">)</span>,</span>
<span>                   <span class="va">all_segments.json</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">nc</span> <span class="op">=</span> <span class="fu"><a href="../reference/neuprint_fetch_custom.html">neuprint_fetch_custom</a></span><span class="op">(</span>cypher<span class="op">=</span><span class="va">cypher</span>, conn <span class="op">=</span> <span class="va">conn</span>, dataset <span class="op">=</span> <span class="va">dataset</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">nc</span><span class="op">$</span><span class="va">data</span>,<span class="va">nullToNA</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="op">=</span> <span class="va">bodyids</span></span>
<span>  <span class="va">d</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p><code>bodyids</code> is the main input argument. These typically come
in as either character vector or numeric format. By passing the argument
to the <code><a href="../reference/neuprint_search.html">neuprint_ids()</a></code> function you can also enable a range
of queries to define the bodyids. The internal function
<code>id2json()</code> is eventually used to look after formatting them
appropriately for the Neo4j cypher query.</p>
<p>In this function, <code>cypher</code> is the actual query written in
the <a href="https://neo4j.com/developer/cypher-query-language/" class="external-link">Cypher
query language</a>. One helpful tip. <em>You can press the i key in
neuPrint explorer to reveal the cypher query</em>!</p>
<p>Many functions that operate on neurons will have an argument
controlling whether they operate only for larger objects (aka
<em>Neuron</em>) or also on fragments (aka <em>Segment</em>).
Restricting queries to <em>Neuron</em> can result in big speed-ups in
some cases. You can provide an <code>all_segments</code> argument to
handle this option.</p>
<p>Finally the results that come back from
<code>neuprint_fetch_custom</code> are typically in a big list object.
For simple results, you can just <code><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist()</a></code> this to make a
vector. In this case a function <code>nullToNA</code> is first applied
in order to ensure that any values that come back as <code>NULL</code>
are converted to <code>NA</code>; this is necessary to ensure that you
can make a vector - vector objects can only contain <code>NA</code>s not
<code>NULL</code>s.</p>
</div>
<div class="section level3">
<h3 id="preparing-the-query">Preparing the query<a class="anchor" aria-label="anchor" href="#preparing-the-query"></a>
</h3>
<p>As you can see this step uses the <code>sprintf</code> function to
interpolate variables into a string. You could do this in other ways
(e.g. the <code><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste()</a></code> function or the <code>glue()</code>
package). You may need to watch out for quoting issues if you should
need to use single or double quotes inside your queries.</p>
</div>
<div class="section level3">
<h3 id="body-ids">Body ids<a class="anchor" aria-label="anchor" href="#body-ids"></a>
</h3>
<p>You need to be a little careful with the handling of body ids. The
basic advice is to pass them to <code><a href="../reference/neuprint_search.html">neuprint_ids()</a></code> on entry to
your function. This will ensure that there is at least one id (unless
<code>mustWork=FALSE</code>) and convert to character vector. It also
allows simple queries (by default exact matches against the type field).
Finally it will by default ensure that only unique ids are passed in.
This is <em>nearly</em> always what you want, but be careful.</p>
<p>In more detail, body ids are 64 bit integers (often called
<code>bigint</code>s), which are commonly used as keys in databases.
However like many programming languages R does not have a native 64 bit
integer type. R’s default numeric format is double width floating point.
This can exactly handle numbers with up to 53 bits of precision.</p>
<p>However, the biggest integer (here data is represented in signed
format <code>int64</code>) that we need to worry about is (2^63)-1 =
9,223,372,036,854,775,807. This cannot be represented as a numeric. I
have yet to spot a body id in this upper range, but the
<code>neuprint_ids</code> function will take care that you do not use
one. If you need to specify a large bodyid as input to your function
then you should insist on</p>
<ul>
<li>character vector input</li>
<li>64 bit integers provided by <code><a href="https://rdrr.io/pkg/bit64/man/bit64-package.html" class="external-link">bit64::integer64()</a></code>
</li>
</ul>
<p>The latter seems better in theory (since it is more compact) than
using character vectors, but it relies on an add-on package (bit64)
rather than base R and I have seen subtle errors when
<code>integer64</code> objects lose their class. In particular you
cannot turn them into a list or run <code>lapply</code> without losing
their class. Therefore I recommend using character vectors where
possible.</p>
<p>Bottom line</p>
<ul>
<li>always apply <code><a href="../reference/neuprint_search.html">neuprint_ids()</a></code> to your incoming body ids
to enable a range of simple queries and check that your input looks
sensible.</li>
<li>always use <code>id2json()</code> on your body ids when building
your cypher</li>
<li>if you work with your body ids inside your function and do not start
by passing them to <code><a href="../reference/neuprint_search.html">neuprint_ids()</a></code>, then at least use
<code>id2char</code> to put them into the most robust standard form (a
character vector).</li>
</ul>
</div>
<div class="section level3">
<h3 id="connecting-to-neuprint">Connecting to neuPrint<a class="anchor" aria-label="anchor" href="#connecting-to-neuprint"></a>
</h3>
<p>In order to make a query, you need to specify which neuPrint
<em>server</em> you want to talk to as well as the <em>dataset</em> you
would like to use. The server is specified by a
<code><a href="../reference/neuprint_login.html">neuprint_connection()</a></code> object. 99% of the time you will not
need to do anything as this will be handled transparently by a one time
user setting to specify their preferred server and authentication
token.</p>
<p>The same is true of the dataset parameter, with the additional
feature that that <code><a href="../reference/neuprint_fetch_custom.html">neuprint_fetch_custom()</a></code> will internally
check for a default dataset for the current server (as defined by the
<code>conn</code> connection object).</p>
<p>However your function must allow people to specify both of these
things if they wish. Therefore your function should look something like
this in outline:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">myquery</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">query</span>, <span class="va">conn</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">dataset</span><span class="op">=</span><span class="cn">NULL</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/neuprint_fetch_custom.html">neuprint_fetch_custom</a></span><span class="op">(</span><span class="va">query</span>, conn<span class="op">=</span><span class="va">conn</span>, dataset<span class="op">=</span><span class="va">dataset</span>, <span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Internally <code><a href="../reference/neuprint_fetch_custom.html">neuprint_fetch_custom()</a></code>, which will look
after the <code>dataset</code> argument, and then go on to call the low
level <code>neuprint_fetch()</code>, which will ensure that the
connection object is valid (or use <code><a href="../reference/neuprint_login.html">neuprint_login()</a></code> to make
one).</p>
</div>
<div class="section level3">
<h3 id="processing-the-results">Processing the results<a class="anchor" aria-label="anchor" href="#processing-the-results"></a>
</h3>
<p>The sample function just ran <code><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist()</a></code> on the list
returned by <code><a href="../reference/neuprint_fetch_custom.html">neuprint_fetch_custom()</a></code>. This is fine in many
cases. You can also pass the <code>simplifyVector</code> argument to
<code><a href="../reference/neuprint_fetch_custom.html">neuprint_fetch_custom()</a></code> and this will clean up many forms
of list. See <code><a href="https://jeroen.r-universe.dev/jsonlite/reference/fromJSON.html" class="external-link">jsonlite::fromJSON()</a></code> for details of how this
operates.</p>
<p>If you are getting a nested list specifying a table (i.e. a
<code>data.frame</code> or spreadsheet like result) then there is a
function <code><a href="../reference/neuprint_list2df.html">neuprint_list2df()</a></code> which will do a lot of the
heavy lifting. It is strongly recommended to make use of this whenever
possible. See <code><a href="../reference/neuprint_get_meta.html">neuprint_get_meta()</a></code> for an example. Note that
<code><a href="../reference/neuprint_list2df.html">neuprint_list2df()</a></code> has an argument with default
<code>stringsAsFactors=FALSE</code> to ensure that columns in the output
<code>data.frame</code> will be character vectors unless you take steps
to make them factors.</p>
</div>
</div>
<div class="section level2">
<h2 id="need-help">Need help?<a class="anchor" aria-label="anchor" href="#need-help"></a>
</h2>
<p>Feel free to ask for help on the <a href="https://groups.google.com/forum/#!forum/nat-user" class="external-link">nat-user google
group</a> or by <a href="https://github.com/natverse/neuprintr/issues/" class="external-link">making an
issue</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Alexander Bates, Gregory Jefferis, Romain Franconville.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

      </footer>
</div>






  </body>
</html>
